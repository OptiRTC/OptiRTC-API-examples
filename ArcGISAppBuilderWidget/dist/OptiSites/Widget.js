var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},__decorate=this&&this.__decorate||function(e,t,r,a){var i,n=arguments.length,o=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,a);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(n<3?i(o):n>3?i(t,r,o):i(t,r))||o);return n>3&&o&&Object.defineProperty(t,r,o),o},__awaiter=this&&this.__awaiter||function(e,t,r,a){return new(r||(r=Promise))((function(i,n){function o(e){try{l(a.next(e))}catch(e){n(e)}}function s(e){try{l(a.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,s)}l((a=a.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var r,a,i,n,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return n={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function s(n){return function(s){return function(n){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,a&&(i=2&n[0]?a.return:n[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,n[1])).done)return i;switch(a=0,i&&(n=[2&n[0],i.value]),n[0]){case 0:case 1:i=n;break;case 4:return o.label++,{value:n[1],done:!1};case 5:o.label++,a=n[1],n=[0];continue;case 7:n=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==n[0]&&2!==n[0])){o=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){o.label=n[1];break}if(6===n[0]&&o.label<i[1]){o.label=i[1],i=n;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(n);break}i[2]&&o.ops.pop(),o.trys.pop();continue}n=t.call(e,o)}catch(e){n=[6,e],a=0}finally{r=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,s])}}},__asyncValues=this&&this.__asyncValues||function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},a("next"),a("throw"),a("return"),t[Symbol.asyncIterator]=function(){return this},t);function a(r){t[r]=e[r]&&function(t){return new Promise((function(a,i){(function(e,t,r,a){Promise.resolve(a).then((function(t){e({value:t,done:r})}),t)})(a,i,(t=e[r](t)).done,t.value)}))}}},__await=this&&this.__await||function(e){return this instanceof __await?(this.v=e,this):new __await(e)},__asyncDelegator=this&&this.__asyncDelegator||function(e){var t,r;return t={},a("next"),a("throw",(function(e){throw e})),a("return"),t[Symbol.iterator]=function(){return this},t;function a(a,i){t[a]=e[a]?function(t){return(r=!r)?{value:__await(e[a](t)),done:"return"===a}:i?i(t):t}:i}},__asyncGenerator=this&&this.__asyncGenerator||function(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var a,i=r.apply(e,t||[]),n=[];return a={},o("next"),o("throw"),o("return"),a[Symbol.asyncIterator]=function(){return this},a;function o(e){i[e]&&(a[e]=function(t){return new Promise((function(r,a){n.push([e,t,r,a])>1||s(e,t)}))})}function s(e,t){try{(r=i[e](t)).value instanceof __await?Promise.resolve(r.value.v).then(l,u):c(n[0][2],r)}catch(e){c(n[0][3],e)}var r}function l(e){s("next",e)}function u(e){s("throw",e)}function c(e,t){e(t),n.shift(),n.length&&s(n[0][0],n[0][1])}},__values=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],a=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&a>=e.length&&(e=void 0),{value:e&&e[a++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},__read=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,i,n=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(a=n.next()).done;)o.push(a.value)}catch(e){i={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(i)throw i.error}}return o},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define(["require","exports","jimu/BaseWidget","./support/declareDecorator","./support/sortedIndex","./support/noop","./support/optiDatastreams","./support/optiDatapoints","./support/eventListenerHelpers","moment/moment","./js/dygraph","./support/waitForLayerToBeAdded","dojo/dom-construct","jimu/LayerStructure","jimu/WidgetManager","esri/layers/FeatureLayer","esri/graphic","esri/InfoTemplate","esri/symbols/PictureMarkerSymbol","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/renderers/SimpleRenderer","esri/SpatialReference","esri/graphicsUtils"],(function(e,t,r,a,i,n,o,s,l,u,c,d,p,h,f,y,m,g,_,v,w,b,S,D){"use strict";r=__importDefault(r),a=__importDefault(a),u=__importDefault(u),c=__importDefault(c),p=__importDefault(p),h=__importDefault(h),f=__importDefault(f),y=__importDefault(y),m=__importDefault(m),g=__importDefault(g),_=__importDefault(_),v=__importDefault(v),w=__importDefault(w),b=__importDefault(b),S=__importDefault(S),D=__importDefault(D);var O="MM/DD/YYYY HH:mm:ss",L=172800,I="widgets/OptiSites/images/icon.png",x={class:"opti-site-data"},P=function(e,t){return e[0]-t[0]},W=function(e,t,r){var a,n;try{for(var o=__values(r),s=o.next();!s.done;s=o.next()){var l=s.value;if(Array.isArray(l.value)&&l.value.length&&"number"==typeof l.value[0].value){var c=l.timeValue,d=l.value[0].value;(!e.minValue||d<e.minValue)&&(e.minValue=d),(!e.maxValue||d>e.maxValue)&&(e.maxValue=d);var p=[u.default.utc(c).local().toDate(),d],h=i.sortedIndex(t,p,P),f=t.length;if(h>=0&&h<f){var y=+P(p,t[h]);if(!(y>0||y<0)){t[h][1]=d;continue}}h===f?t.push(p):t.splice(h,0,p)}}}catch(e){a={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(a)throw a.error}}return function(e){var t,r;return{stopAllIteration:function(){return r=!0},filteredAccPoints:(t={},t[Symbol.iterator]=function(){var t,a,i,n,o,s,l;return __generator(this,(function(u){switch(u.label){case 0:t=null,u.label=1;case 1:u.trys.push([1,9,10,11]),a=__values(e),i=a.next(),u.label=2;case 2:return i.done?[3,8]:(n=i.value,r?[3,8]:t&&t[1]===n[1]?[3,6]:t?[4,t]:[3,4]);case 3:u.sent(),t=null,u.label=4;case 4:return[4,n];case 5:return u.sent(),[3,7];case 6:t=n,u.label=7;case 7:return i=a.next(),[3,2];case 8:return[3,11];case 9:return o=u.sent(),s={error:o},[3,11];case 10:try{i&&!i.done&&(l=a.return)&&l.call(a)}finally{if(s)throw s.error}return[7];case 11:return t?[4,t]:[3,13];case 12:u.sent(),u.label=13;case 13:return[2]}}))},t)}}(t)};return function(){function e(){this.baseClass="OptiSites",this.layerStructure=h.default.getInstance(),this.esriWidgetManager=f.default.getInstance(),this.siteDataByName=new Map,this.infoTemplateDomDataByName=new Map,this.dygraphByParentEl=new WeakMap}var t;return t=e,e.prototype.postCreate=function(){var e=this;e.inherited(t.prototype.postCreate,arguments),this.createOptiSitesLayer()},e.prototype.startup=function(){var e=this;e.inherited(t.prototype.startup,arguments)},e.prototype.createOptiSitesLayer=function(){return __awaiter(this,void 0,void 0,(function(){var e,t,r,a,i,n,o,s,l,c,p,h,f,D,L,x,P,W=this;return __generator(this,(function(E){switch(E.label){case 0:return this.optiSitesLayer?[3,3]:(e=new _.default(I,22.5,18.5),(t=new b.default(e)).label="Opti Site",r={geometryType:"esriGeometryPoint",description:"Sites managed by OptiRTC Inc (www.optirtc.com)",htmlPopupType:y.default.POPUP_HTML_TEXT,mode:y.default.MODE_ONDEMAND,objectIdField:"name",displayField:"name",type:"Feature Layer",fields:[{name:"name",type:"esriFieldTypeOID",alias:"Opti Site Name"},{name:"availableKPIs",type:"esriFieldTypeInteger",alias:"Available KPIs"},{name:"installedOn",type:"esriFieldTypeDate",alias:"Installed On (UTC ISO 8601)"},{name:"installedOnLocal",type:"esriFieldTypeString",alias:"Installed On (local)"}]},a=new g.default("${name}",(function(e){return W.getInfoTemplateContent(e)})),this.optiSitesLayer=new y.default({layerDefinition:r,featureSet:null},{id:"OptiSites",className:"OptiSitesLayer",visible:!!this.config.optiSitesLayerVisibleOnStart,showLabels:!0,showAttribution:!0,outFields:["*"],infoTemplate:a}),this.optiSitesLayer.name="Opti Sites",this.optiSitesLayer.attributionDataUrl="https://www.optirtc.com",this.optiSitesLayer.renderer=t,[4,this.createSiteData()]);case 1:if((i=E.sent())&&i.length){n=new S.default(4326);try{for(o=__values(i),s=o.next();!s.done;s=o.next())l=s.value,c=l.name,p=l.installedOn,h=l.availableKPIs,f=w.default.geographicToWebMercator(new v.default(l.location.coordinates,n)),D=new m.default(f,e,{name:c,installedOn:p,installedOnLocal:(T=p,u.default.utc(T).local().format(O)),availableKPIs:h}),this.siteDataByName.set(c,l),this.optiSitesLayer.add(D)}catch(e){x={error:e}}finally{try{s&&!s.done&&(P=o.return)&&P.call(o)}finally{if(x)throw x.error}}}return this.map.addLayer(this.optiSitesLayer),L=this,[4,d.waitForLayerToBeAdded(this.layerStructure,this.optiSitesLayer)];case 2:L.optiSitesLayerNode=E.sent(),this.config.zoomToFitOptiSites&&this.zoomToFitOptiSites(),E.label=3;case 3:return this.esriWidgetManager.closeWidget(this),[2,this.optiSitesLayer]}var T}))}))},e.prototype.createSiteData=function(){var e,t;return __awaiter(this,void 0,void 0,(function(){var r,a,i,n,s,l,u,c,d,p,h,f,y,m,g,_,v,w,b;return __generator(this,(function(S){switch(S.label){case 0:r=new Map,a=this.config.optiAPIKey,i=/^(.*)-((.*):(.*))$/,S.label=1;case 1:S.trys.push([1,6,7,12]),n=__asyncValues(o.getDatastreams(a)),S.label=2;case 2:return[4,n.next()];case 3:if((s=S.sent()).done)return[3,5];(l=s.value)&&l.title&&l.location&&Array.isArray(l.location.coordinates)&&(i.lastIndex=0,(u=i.exec(l.title))&&(c=__read(u,5),d=c[1],p=c[3],h=c[4],f=l.id,y=l.unitAbbreviation,"string"==typeof d&&(d=d.trim()),"string"==typeof p&&(p=p.trim()),"string"==typeof h&&(h=h.trim()),(m=r.get(d))||(m={availableKPIs:0,lngSum:0,latSum:0,installedOn:"",charts:[]},r.set(d,m)),g=__read(l.location.coordinates,2),_=g[0],v=g[1],m.lngSum+=_,m.latSum+=v,(!m.installedOn||"string"==typeof l.validFrom&&l.validFrom<m.installedOn)&&(m.installedOn=l.validFrom),m.availableKPIs++,m.charts.push(this.chartDataFactory(f,h,p,y)))),S.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return w=S.sent(),e={error:w},[3,12];case 7:return S.trys.push([7,,10,11]),s&&!s.done&&(t=n.return)?[4,t.call(n)]:[3,9];case 8:S.sent(),S.label=9;case 9:return[3,11];case 10:if(e)throw e.error;return[7];case 11:return[7];case 12:return b=Array.from(r.entries()).map((function(e){var t=__read(e,2),r=t[0],a=t[1],i=a.installedOn,n=a.lngSum,o=a.latSum,s=a.availableKPIs;return{name:r,installedOn:i,location:{type:"Point",coordinates:[n/s,o/s]},availableKPIs:s,charts:a.charts}})),r.clear(),[2,b]}}))}))},e.prototype.getInfoTemplateContent=function(e){var t=this,r=null==e?void 0:e.attributes.name,a=this.siteDataByName.get(r),i=this.infoTemplateDomDataByName.get(r);if(a){if(i&&i.root)i.chartLoadingStates.forEach((function(e){e.loaded=!1,e.loadingId++,e.disposeDygraph&&(e.disposeDygraph(),delete e.disposeDygraph)})),p.default.empty(i.root);else{var o=!1,s=[this.map.infoWindow.on("hide",(function(){i&&i.dispose()})).remove,this.map.infoWindow.on("selection-change",(function(e){if(i){var t=Array.isArray(null==e?void 0:e.target.features)&&e.target.features[0]&&e.target.features[0].attributes.name;r!==t&&i.dispose()}})).remove,function(){i&&(i.root&&(p.default.empty(i.root),p.default.destroy(i.root),i.root=null),i.intro&&i.intro.dispose(),i.dispose=n.noop,i.chartLoadingStates.forEach((function(e){e.loadingId++,e.disposeDygraph&&(e.disposeDygraph(),delete e.disposeDygraph)})),i=void 0,t.infoTemplateDomDataByName.delete(r))}];i={root:p.default.create("div",x),chartLoadingStates:a.charts.map((function(){return{loaded:!1,loadingId:0,get shouldStopLoading(){return!i||i.wasPlacedAndNotPlaced}}})),get isPlaced(){if(i){var e=!(!i.root||!i.root.parentElement);return e&&(o=!0),e}return!1},get wasPlacedAndNotPlaced(){return i&&!i.isPlaced&&o||!1},dispose:function(){s.forEach((function(e){return e()})),s.length=0}},this.infoTemplateDomDataByName.set(r,i)}var l=i.root;this.createOrUpdateIntro(i);var u=p.default.place('<div class="opti-site-charts"></div>',l),c=i.chartLoadingStates;return a.charts.forEach((function(e,r){return __awaiter(t,void 0,void 0,(function(){var t,a,i,n,o,s,l,d,h,f,y,m,g,_,v,w=this;return __generator(this,(function(b){switch(b.label){case 0:t=e.title,a=e.unit,i=e.asyncPointsUpdates,n=c[r],o=p.default.place('<div class="opti-site-chart"></div>',u),p.default.place(function(e,t){return"<h2><b>"+e+(t?": <i>("+t+")</i>":"")+"</b></h2>"}(t,a),o),s=p.default.place('<div class="opti-site-chart-legend"></div>',o),l=p.default.place('<div class="dygraph-container"></div>',o),n.disposeDygraph=function(){return w.disposeDigraphForEl(l)},this.createOrUpdateDygraph(l,s,e,[],!0),d=[],h=n.loadingId,b.label=1;case 1:b.trys.push([1,14,,15]),b.label=2;case 2:b.trys.push([2,7,8,13]),f=__asyncValues(i),b.label=3;case 3:return[4,f.next()];case 4:if((y=b.sent()).done)return[3,6];if(m=y.value,h!==n.loadingId||n.shouldStopLoading)return this.disposeDigraphForEl(l),p.default.destroy(o),[2];d=m,this.createOrUpdateDygraph(l,s,e,Array.from(d),!0),b.label=5;case 5:return[3,3];case 6:return[3,13];case 7:return g=b.sent(),_={error:g},[3,13];case 8:return b.trys.push([8,,11,12]),y&&!y.done&&(v=f.return)?[4,v.call(f)]:[3,10];case 9:b.sent(),b.label=10;case 10:return[3,12];case 11:if(_)throw _.error;return[7];case 12:return[7];case 13:return h===n.loadingId?this.createOrUpdateDygraph(l,s,e,Array.from(d),!1):(this.disposeDigraphForEl(l),p.default.destroy(o)),[3,15];case 14:return b.sent(),h===n.loadingId?this.createOrUpdateDygraph(l,s,e,Array.from(d),!1):(this.disposeDigraphForEl(l),p.default.destroy(o)),[3,15];case 15:return[2]}}))}))})),l}return i&&i.dispose(),"Unknown site"},e.prototype.createOrUpdateDygraph=function(e,t,r,a,i){var o=this,s=this.dygraphByParentEl.get(e);if(i){if(s||(s={dispose:function(){s&&s.loadingNoticeEl&&(p.default.destroy(s.loadingNoticeEl),delete s.loadingNoticeEl)},loadingNoticeEl:p.default.place("<p>Loading...</p>",e)},this.dygraphByParentEl.set(e,s)),a.length>1)if(s.d)s.updateDygraph&&s.updateDygraph(a);else{var l=this.isInfoWindowMaximized(),u={axisLabelWidth:l?50:0},d=__assign(__assign({labelsDiv:t,axes:{y:u}},this.getDygraphWidthAndHeight(l)),{hideOverlayOnMouseOut:!1,labelsSeparateLines:!0,labels:["",r.title],legend:l?"always":"never",legendFormatter:function(e){if(null==e.x)return"<br>"+e.series.map((function(e){return e.dashHTML+" "+e.labelHTML})).join("<br>");var t=e.xHTML;return e.series.forEach((function(e){if(e.isVisible){var a=e.labelHTML+": "+e.yHTML;e.isHighlighted&&(a="<b>"+a+"</b>"),t+="<br>"+e.dashHTML+" "+a+" "+(r.unit&&"state"!==r.unit?"<i> "+r.unit+"</i>":"")}})),t}}),h=[s.dispose,this.map.infoWindow.on("maximize",(function(){var e=s&&s.d;e&&(Object.assign(d,__assign({legend:"always"},o.getDygraphWidthAndHeight(!0))),Object.assign(u,{axisLabelWidth:50}),e.updateOptions(d),d.width&&d.height&&e.resize(d.width,d.height))})).remove,this.map.infoWindow.on("restore",(function(){var e=s&&s.d;e&&(Object.assign(d,__assign({legend:"never"},o.getDygraphWidthAndHeight(!1))),Object.assign(u,{axisLabelWidth:0}),e.updateOptions(d),d.width&&d.height&&e.resize(d.width,d.height))})).remove,function(){s&&(s.d&&s.d.destroy(),p.default.destroy(t),p.default.destroy(e),delete s.d,delete s.updateDygraph,s.dispose=n.noop),d&&Object.keys(d).forEach((function(e){Object.prototype.hasOwnProperty.call(d,e)&&delete d[e]})),h.length=0,o.dygraphByParentEl.delete(e)}];Object.assign(s,{d:new c.default(e,a,d),updateDygraph:function(e){var t=s&&s.d;if(t&&d){var r=o.getDygraphWidthAndHeight(),a=r.width,i=r.height;Object.assign(d,__assign({file:e},{width:a,height:i})),t.updateOptions(d),d.width&&d.height&&t.resize(d.width,d.height)}},dispose:function(){return h.forEach((function(e){return e()}))}})}}else s&&s.loadingNoticeEl&&p.default.destroy(s.loadingNoticeEl),a.length||p.default.place('<p class="opti-site-chart-no-points">No points.</p>',e)},e.prototype.disposeDigraphForEl=function(e){var t=(this.dygraphByParentEl.get(e)||{}).dispose;t&&(t(),this.dygraphByParentEl.delete(e))},e.prototype.clearFeatureLayer=function(){this.optiSitesLayer&&this.optiSitesLayer.clear()},e.prototype.zoomToFitOptiSites=function(){if(this.optiSitesLayer){var e=D.default.graphicsExtent(this.optiSitesLayer.graphics);e?this.map.setExtent(e,!0):Array.isArray(this.optiSitesLayer.graphics)&&this.optiSitesLayer.graphics&&this.optiSitesLayer.graphics.length&&this.optiSitesLayer.graphics[0].geometry&&this.map.centerAndZoom(this.optiSitesLayer.graphics[0].geometry,8)}},e.prototype.chartDataFactory=function(e,t,r,a){var i={dataStreamId:e,title:t};return r&&(i.product=r),a&&(i.unit=a),i.asyncPointsUpdates=this.asyncPointsUpdatesFactory(i),i},e.prototype.asyncPointsUpdatesFactory=function(e){var t,r,a,i,o=this.config.optiAPIKey,l=e.dataStreamId,c=[],d=new Set,p=function(e){void 0===e&&(e=!1),r&&d.forEach((function(t){try{t(r||[],e)}catch(e){}}))},h=!1,f=((t={})[Symbol.asyncIterator]=function(){return __asyncGenerator(this,arguments,(function(){var t,y,m,g,_,v,w,b,S,D,I;return __generator(this,(function(x){switch(x.label){case 0:if(t=u.default.utc(),h||a&&i===a&&!(t.diff(i,"m")>3))return[3,18];h=!0,a=t,delete e.minValue,delete e.maxValue,e.startFormatted=t.clone().local().format(O),e.endFormatted=t.clone().local().subtract(L,"s").format(O),c.length=0,r=[],y=t.toISOString(),m=n.noop,x.label=1;case 1:x.trys.push([1,,16,17]),x.label=2;case 2:x.trys.push([2,9,10,15]),g=__asyncValues(s.getDatapointChunks(o,{dataStreamId:l,utcModern:y,tss:L})),x.label=3;case 3:return[4,__await(g.next())];case 4:return(_=x.sent()).done?[3,8]:(v=_.value,m(),S=W(e,c,v),m=S.stopAllIteration,r=S.filteredAccPoints,[4,__await(r)]);case 5:return[4,x.sent()];case 6:x.sent(),p(),x.label=7;case 7:return[3,3];case 8:return[3,15];case 9:return w=x.sent(),D={error:w},[3,15];case 10:return x.trys.push([10,,13,14]),_&&!_.done&&(I=g.return)?[4,__await(I.call(g))]:[3,12];case 11:x.sent(),x.label=12;case 12:return[3,14];case 13:if(D)throw D.error;return[7];case 14:return[7];case 15:return i=a,[3,17];case 16:return p(i!==a),m=n.noop,h=!1,[7];case 17:return[3,28];case 18:return[4,__await(r||[])];case 19:return[4,x.sent()];case 20:x.sent(),b=!1,x.label=21;case 21:return h?[4,__await(new Promise((function(e){var t=function(r,a){return e(r),d.delete(t),b=a};d.add(t)})))]:[3,25];case 22:return[4,__await.apply(void 0,[x.sent()])];case 23:return[4,x.sent()];case 24:return x.sent(),[3,21];case 25:return b?[5,__values(__asyncDelegator(__asyncValues(f)))]:[3,28];case 26:return[4,__await.apply(void 0,[x.sent()])];case 27:x.sent(),x.label=28;case 28:return[2]}}))}))},t);return f},e.prototype.onOpen=function(){this.optiSitesLayerNode&&this.esriWidgetManager.closeWidget(this)},e.prototype.getDygraphWidthAndHeight=function(e){void 0===e&&(e=this.isInfoWindowMaximized());var t=this.getInfoWindowContentNode();if(t){var r=t.clientWidth,a=t.clientHeight;return{width:r-20,height:e?a<125?50:Math.round(.4*a):50}}return{}},e.prototype.isInfoWindowMaximized=function(){if(this.map&&this.map.infoWindow){if(Object.prototype.hasOwnProperty.call(this.map.infoWindow,"_maximized")&&"boolean"==typeof this.map.infoWindow._maxmized)return!0===this.map.infoWindow._maxmized;var e=this.map.infoWindow.domNode;return!(!e||!e.classList.contains("esriPopupVisible"))&&e.classList.contains("esriPopupMaximized")}return!1},e.prototype.getInfoWindowContentNode=function(){var e=this.map.infoWindow.domNode;if(e&&e.classList.contains("esriPopupVisible"))return e.querySelector(".contentPane")},e.prototype.createOrUpdateIntro=function(e){var t=this;if(e.root){var r=e.intro,a=(r||{el:p.default.place('<div class="opti-site-intro"></div>',e.root)}).el;if(r){r.disposeToggleSizeHint&&r.disposeToggleSizeHint(),__read(a.children).slice(1).forEach((function(e){return e.remove()}))}else{p.default.place('<h2><img src="widgets/OptiSites/images/icon.png" class="opti-logo">Opti Site</h2>',a);var i=this.createOrUpdateIntro.bind(this,e),n=[this.map.infoWindow.on("maximize",i).remove,this.map.infoWindow.on("restore",i).remove];e.intro={el:a,dispose:function(){e.intro&&(p.default.destroy(e.intro.el),n.forEach((function(e){return e()})),n.length=0,delete e.intro)}}}var o=p.default.place('<p>Opti uses real-time weather forecast and sensor data to predict and automate decisions that optimize the site\'s stormwater infrastructure.  Real-time data from the last 72-hours from this site is provided in the graphs below. For more information, please visit <a target="_blank" rel="noopener noreferrer" href="https://optirtc.com">https://optirtc.com</a>. '+(this.isInfoWindowMaximized()?'<a href="#">Restore View</a>':'<a href="#">Maximize View</a>')+"</p>",a),s=o.getElementsByTagName("a"),u=s[s.length-1],c=l.addElementEventListener({t:"click",e:u,h:function(){t.map.infoWindow&&(t.isInfoWindowMaximized()?"function"==typeof t.map.infoWindow.restore&&t.map.infoWindow.restore():"function"==typeof t.map.infoWindow.maximize&&t.map.infoWindow.maximize())}});e.intro&&(e.intro.disposeToggleSizeHint=function(){c(),u.remove(),o.remove()})}},e=t=__decorate([a.default(r.default)],e)}()}));